language: node_js
node_js:
  - 10

cache:
  directories:
  - "$HOME/.npm"

install:
- npm ci

stages:
  - name: test
  - name: npm deploy
    if: branch = release

jobs:
  include:
    - stage: test
      script: npm run test -- --maxWorkers=4
    - stage: npm deploy
      before_install: 
        - openssl aes-256-cbc -K $encrypted_4f66e85e9eb1_key -iv $encrypted_4f66e85e9eb1_iv -in env.tar.enc -out env.tar -d
        - tar xvf env.tar
      script: skip
      after_success: true
      before_deploy:
        - npm run build
      deploy:
        provider: script
        script: netlify deploy -s $NETLIFY_SITE_ID --auth $NETLIFY_PUBLISH_KEY -p --dir ./dist
        skip_cleanup: true
        on:
          branch: release

